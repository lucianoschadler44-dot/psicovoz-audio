<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsicoVoz - Assistente Terap√™utico por Voz</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px 0; border-bottom: 1px solid #ffffff20; margin-bottom: 20px; }
        header h1 { font-size: 2em; margin-bottom: 5px; }
        header p { color: #888; font-size: 0.9em; }
        .screen { display: none; }
        .screen.active { display: block; }
        .approaches { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        @media (max-width: 768px) { .approaches, .therapists { grid-template-columns: 1fr; } }
        .approach-card {
            background: #ffffff10; border: 2px solid #ffffff20; border-radius: 15px;
            padding: 30px 20px; cursor: pointer; transition: all 0.3s ease; text-align: center;
        }
        .approach-card:hover { background: #ffffff20; border-color: #4a90a4; transform: translateY(-5px); }
        .approach-card .icon { font-size: 3em; margin-bottom: 15px; }
        .approach-card h3 { margin-bottom: 10px; color: #4a90a4; font-size: 1.2em; }
        .approach-card p { font-size: 0.85em; color: #aaa; line-height: 1.4; }
        .therapists { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .therapist-card {
            background: #ffffff10; border: 2px solid #ffffff20; border-radius: 15px;
            padding: 25px; cursor: pointer; transition: all 0.3s ease; text-align: center;
        }
        .therapist-card:hover { background: #ffffff20; transform: translateY(-5px); border-color: var(--hover-color, #4a90a4); }
        .therapist-card .avatar { font-size: 3em; margin-bottom: 10px; }
        .therapist-card h3 { color: #4a90a4; margin-bottom: 5px; }
        .therapist-card .years { font-size: 0.75em; color: #666; margin-bottom: 8px; }
        .therapist-card .specialty { font-size: 0.85em; color: #aaa; font-style: italic; margin-bottom: 8px; }
        .therapist-card .style { font-size: 0.75em; color: #888; line-height: 1.4; margin-bottom: 8px; padding: 8px; background: #ffffff08; border-radius: 8px; }
        .therapist-card .quote { font-size: 0.75em; color: #666; font-style: italic; margin-top: 8px; }
        .chat-header { display: flex; align-items: center; gap: 20px; padding: 20px; background: #ffffff10; border-radius: 15px; margin-bottom: 20px; }
        .avatar-container {
            width: 100px; height: 100px; border-radius: 50%; border: 3px solid #4a90a4;
            display: flex; align-items: center; justify-content: center; font-size: 3em; background: #1a1a2e;
        }
        .therapist-info h2 { color: #4a90a4; margin-bottom: 5px; }
        .therapist-info p { color: #888; font-size: 0.9em; }
        .therapist-info .quote { font-style: italic; color: #aaa; font-size: 0.8em; margin-top: 5px; }
        .therapist-info .style-badge { font-size: 0.75em; color: #666; margin-top: 5px; }
        .chat-messages { height: 280px; overflow-y: auto; padding: 20px; background: #ffffff05; border-radius: 15px; margin-bottom: 20px; }
        .message { margin-bottom: 15px; padding: 12px 18px; border-radius: 15px; max-width: 85%; animation: fadeIn 0.3s ease; line-height: 1.5; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.therapist { background: linear-gradient(135deg, #2d4a5e, #1a3a4a); margin-right: auto; border-bottom-left-radius: 5px; }
        .message.user { background: linear-gradient(135deg, #4a3728, #3a2718); margin-left: auto; border-bottom-right-radius: 5px; }
        .input-area { display: flex; gap: 10px; align-items: center; }
        .input-area input {
            flex: 1; padding: 15px 20px; border: none; border-radius: 25px;
            background: #ffffff15; color: #fff; font-size: 1em;
        }
        .input-area input::placeholder { color: #666; }
        .input-area input:focus { outline: 2px solid #4a90a4; }
        .input-area button {
            padding: 15px 25px; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #4a90a4, #357a8a); color: #fff;
            font-size: 1em; cursor: pointer; transition: all 0.3s ease;
        }
        .input-area button:hover { transform: scale(1.05); }
        .input-area button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Bot√£o de Microfone */
        .mic-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff;
            font-size: 1.5em; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .mic-btn:hover { transform: scale(1.1); }
        .mic-btn.recording {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(46, 204, 113, 0); }
        }
        
        /* Indicador de fala */
        .speaking-indicator {
            display: none; align-items: center; justify-content: center;
            gap: 5px; padding: 10px; color: #4a90a4;
        }
        .speaking-indicator.active { display: flex; }
        .speaking-indicator .dot {
            width: 8px; height: 8px; background: #4a90a4; border-radius: 50%;
            animation: bounce 0.6s infinite alternate;
        }
        .speaking-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .speaking-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { to { transform: translateY(-10px); opacity: 0.3; } }
        
        .back-btn { background: #ffffff20; border: none; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-bottom: 20px; }
        .back-btn:hover { background: #ffffff30; }
        .status { text-align: center; padding: 10px; color: #888; font-size: 0.85em; }
        .status.connected { color: #4a9; }
        .status.error { color: #a44; }
        .crisis-alert { background: linear-gradient(135deg, #8b0000, #a00); padding: 20px; border-radius: 15px; margin: 15px 0; text-align: center; }
        .crisis-alert a { color: #fff; font-weight: bold; font-size: 1.3em; }
        .disclaimer { background: #ffffff10; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 0.8em; color: #888; text-align: center; }
        .section-title { text-align: center; margin-bottom: 10px; }
        .section-title h2 { font-size: 1.5em; margin-bottom: 5px; }
        .section-title p { color: #888; }
        .line-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; margin-bottom: 15px; }
        .line-badge.psicanalise { background: #8B451320; color: #D2691E; }
        .line-badge.gestalt { background: #228B2220; color: #32CD32; }
        .line-badge.tcc { background: #4682B420; color: #87CEEB; }
        
        .voice-mode-info { text-align: center; padding: 10px; background: #ffffff10; border-radius: 10px; margin-bottom: 15px; }
        .voice-mode-info p { font-size: 0.85em; color: #aaa; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéôÔ∏è PsicoVoz</h1>
            <p>Assistente Terap√™utico por Voz - Apoio Psicol√≥gico</p>
        </header>

        <!-- TELA 1: Escolher Linha -->
        <div id="screen-lines" class="screen active">
            <div class="section-title">
                <h2>Escolha a Linha Terap√™utica</h2>
                <p>Cada abordagem oferece uma perspectiva √∫nica</p>
            </div>
            <div class="approaches">
                <div class="approach-card" onclick="selectLine('psicanalise')">
                    <div class="icon">üõãÔ∏è</div>
                    <h3>Psican√°lise</h3>
                    <p>Explora√ß√£o do inconsciente, sonhos, hist√≥ria pessoal e padr√µes de repeti√ß√£o</p>
                </div>
                <div class="approach-card" onclick="selectLine('gestalt')">
                    <div class="icon">üîÆ</div>
                    <h3>Gestalt</h3>
                    <p>Foco no aqui-agora, consci√™ncia corporal, experi√™ncia presente e totalidade</p>
                </div>
                <div class="approach-card" onclick="selectLine('tcc')">
                    <div class="icon">üìä</div>
                    <h3>TCC</h3>
                    <p>Terapia Cognitivo-Comportamental: pensamentos, emo√ß√µes e comportamentos</p>
                </div>
            </div>
            <div class="disclaimer">
                ‚ö†Ô∏è Este assistente √© um complemento ao tratamento profissional, n√£o um substituto. Em caso de crise, ligue CVV: 188
            </div>
        </div>

        <!-- TELA 2: Escolher Terapeuta -->
        <div id="screen-therapists" class="screen">
            <button class="back-btn" onclick="backToLines()">‚Üê Voltar</button>
            <div class="section-title">
                <span class="line-badge" id="line-badge">Linha</span>
                <h2>Escolha seu Terapeuta</h2>
                <p>Cada um com estilo e abordagem √∫nicos</p>
            </div>
            <div class="therapists" id="therapists-grid"></div>
        </div>

        <!-- TELA 3: Chat com Voz -->
        <div id="screen-chat" class="screen">
            <button class="back-btn" onclick="backToTherapists()">‚Üê Voltar</button>
            <div class="chat-header">
                <div class="avatar-container" id="avatar">üë§</div>
                <div class="therapist-info">
                    <h2 id="therapist-name">Terapeuta</h2>
                    <p id="therapist-desc">Conectando...</p>
                    <p class="quote" id="therapist-quote"></p>
                    <p class="style-badge" id="therapist-style"></p>
                </div>
            </div>
            
            <div class="voice-mode-info">
                <p>üé§ Clique no microfone e fale OU digite sua mensagem</p>
            </div>
            
            <div class="chat-messages" id="messages"></div>
            
            <div class="speaking-indicator" id="speaking-indicator">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <span style="margin-left: 10px;">Terapeuta falando...</span>
            </div>
            
            <div class="status" id="status">Conectando...</div>
            
            <div class="input-area">
                <button class="mic-btn" id="mic-btn" onclick="toggleRecording()">üé§</button>
                <input type="text" id="user-input" placeholder="Ou digite sua mensagem..." onkeypress="if(event.key==='Enter')sendMessage()">
                <button onclick="sendMessage()">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentLine = null;
        let currentTherapist = null;
        let isRecording = false;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let voices = [];

        // Dados dos terapeutas com g√™nero para voz
        const therapistsData = {
            psicanalise: [
                { 
                    id: 'freud', name: 'Sigmund Freud', years: '1856-1939', avatar: 'üßî', 
                    specialty: 'Pai da Psican√°lise', gender: 'male',
                    style: 'Explora√ß√£o do inconsciente, sonhos, livre associa√ß√£o, transfer√™ncia',
                    quote: '"O sonho √© a estrada real para o inconsciente"',
                    color: '#8B4513'
                },
                { 
                    id: 'lacan', name: 'Jacques Lacan', years: '1901-1981', avatar: 'üë§',
                    specialty: 'Psican√°lise Estrutural', gender: 'male',
                    style: 'Linguagem, significantes, desejo do Outro, Real-Simb√≥lico-Imagin√°rio',
                    quote: '"O inconsciente √© estruturado como linguagem"',
                    color: '#4169E1'
                },
                { 
                    id: 'jung', name: 'Carl Jung', years: '1875-1961', avatar: 'üåô',
                    specialty: 'Psicologia Anal√≠tica', gender: 'male',
                    style: 'Arqu√©tipos, inconsciente coletivo, sombra, individua√ß√£o, sonhos simb√≥licos',
                    quote: '"Quem olha para fora sonha, quem olha para dentro desperta"',
                    color: '#9932CC'
                }
            ],
            gestalt: [
                { 
                    id: 'fritz', name: 'Fritz Perls', years: '1893-1970', avatar: 'üîÆ',
                    specialty: 'Fundador da Gestalt', gender: 'male',
                    style: 'Direto, confrontador, aqui-agora, awareness corporal, experimentos',
                    quote: '"Perca a cabe√ßa e caia em si"',
                    color: '#228B22'
                },
                { 
                    id: 'laura', name: 'Laura Perls', years: '1905-1990', avatar: 'üí´',
                    specialty: 'Gestalt Relacional', gender: 'female',
                    style: 'Acolhedora, suporte, contato, presen√ßa, respira√ß√£o, grounding',
                    quote: '"O contato √© a realiza√ß√£o da diferen√ßa"',
                    color: '#3CB371'
                },
                { 
                    id: 'zinker', name: 'Joseph Zinker', years: '1934-2017', avatar: 'üé®',
                    specialty: 'Gestalt Criativa', gender: 'male',
                    style: 'Art√≠stico, met√°foras, experimentos criativos, imagina√ß√£o, poesia',
                    quote: '"A terapia √© uma obra de arte em cria√ß√£o"',
                    color: '#2E8B57'
                }
            ],
            tcc: [
                { 
                    id: 'beck', name: 'Aaron Beck', years: '1921-2021', avatar: 'üìä',
                    specialty: 'Pai da Terapia Cognitiva', gender: 'male',
                    style: 'Colaborativo, pensamentos autom√°ticos, evid√™ncias, questionamento socr√°tico',
                    quote: '"Nossos pensamentos moldam nossa realidade"',
                    color: '#4682B4'
                },
                { 
                    id: 'ellis', name: 'Albert Ellis', years: '1913-2007', avatar: '‚ö°',
                    specialty: 'TREC - Terapia Racional Emotiva', gender: 'male',
                    style: 'Confronta√ß√£o de cren√ßas irracionais, modelo ABC',
                    quote: '"N√£o s√£o os eventos que nos perturbam, mas nossa vis√£o sobre eles"',
                    color: '#B22222'
                },
                { 
                    id: 'judith', name: 'Judith Beck', years: '1954-', avatar: 'üìö',
                    specialty: 'TCC Contempor√¢nea', gender: 'female',
                    style: 'Estruturada, did√°tica, tarefas pr√°ticas, cart√µes de enfrentamento',
                    quote: '"A mudan√ßa cognitiva facilita a mudan√ßa comportamental"',
                    color: '#5F9EA0'
                }
            ]
        };

        // Inicializar reconhecimento de voz
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('user-input').value = text;
                    sendMessage();
                };

                recognition.onend = () => {
                    isRecording = false;
                    document.getElementById('mic-btn').classList.remove('recording');
                };

                recognition.onerror = (event) => {
                    console.error('Erro no reconhecimento:', event.error);
                    isRecording = false;
                    document.getElementById('mic-btn').classList.remove('recording');
                    if (event.error === 'not-allowed') {
                        alert('Permiss√£o de microfone negada. Por favor, permita o acesso ao microfone.');
                    }
                };
            } else {
                console.warn('Reconhecimento de voz n√£o suportado');
                document.getElementById('mic-btn').style.display = 'none';
            }
        }

        // Carregar vozes dispon√≠veis
        function loadVoices() {
            voices = synthesis.getVoices();
            console.log('Vozes dispon√≠veis:', voices.map(v => `${v.name} (${v.lang})`));
        }

        // Carregar vozes quando dispon√≠veis
        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        // Selecionar voz baseada no g√™nero e idioma
        function selectVoice(gender) {
            const voiceList = synthesis.getVoices();
            
            // Prioridades de busca
            const priorities = [
                // PT-BR
                (v) => v.lang === 'pt-BR' && v.name.toLowerCase().includes(gender === 'female' ? 'femin' : 'mascul'),
                (v) => v.lang === 'pt-BR' && ((gender === 'female' && v.name.toLowerCase().includes('luciana')) || (gender === 'male' && v.name.toLowerCase().includes('daniel'))),
                (v) => v.lang === 'pt-BR',
                // PT-PT
                (v) => v.lang === 'pt-PT',
                (v) => v.lang.startsWith('pt'),
                // ES como fallback
                (v) => v.lang.startsWith('es') && ((gender === 'female' && v.name.toLowerCase().includes('femin')) || (gender === 'male' && !v.name.toLowerCase().includes('femin'))),
                (v) => v.lang.startsWith('es'),
                // Qualquer voz
                (v) => true
            ];

            for (const priority of priorities) {
                const voice = voiceList.find(priority);
                if (voice) {
                    console.log(`Voz selecionada: ${voice.name} (${voice.lang}) para g√™nero ${gender}`);
                    return voice;
                }
            }
            
            return voiceList[0]; // Fallback
        }

        // Falar texto
        function speak(text, gender = 'male') {
            return new Promise((resolve) => {
                if (!synthesis) {
                    console.warn('S√≠ntese de voz n√£o suportada');
                    resolve();
                    return;
                }

                // Cancelar fala anterior
                synthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = selectVoice(gender);
                utterance.rate = 0.9; // Um pouco mais lento para clareza
                utterance.pitch = gender === 'female' ? 1.1 : 0.9;
                utterance.volume = 1;

                // Mostrar indicador
                document.getElementById('speaking-indicator').classList.add('active');

                utterance.onend = () => {
                    document.getElementById('speaking-indicator').classList.remove('active');
                    resolve();
                };

                utterance.onerror = (event) => {
                    console.error('Erro na s√≠ntese:', event);
                    document.getElementById('speaking-indicator').classList.remove('active');
                    resolve();
                };

                synthesis.speak(utterance);
            });
        }

        // Toggle grava√ß√£o
        function toggleRecording() {
            if (!recognition) {
                alert('Reconhecimento de voz n√£o suportado neste navegador. Use Chrome para melhor experi√™ncia.');
                return;
            }

            if (isRecording) {
                recognition.stop();
                isRecording = false;
                document.getElementById('mic-btn').classList.remove('recording');
            } else {
                recognition.start();
                isRecording = true;
                document.getElementById('mic-btn').classList.add('recording');
            }
        }

        function selectLine(line) {
            currentLine = line;
            showScreen('screen-therapists');
            renderTherapists(line);
            
            const badge = document.getElementById('line-badge');
            badge.className = 'line-badge ' + line;
            badge.textContent = line === 'psicanalise' ? 'üõãÔ∏è Psican√°lise' : 
                               line === 'gestalt' ? 'üîÆ Gestalt' : 'üìä TCC';
        }

        function renderTherapists(line) {
            const grid = document.getElementById('therapists-grid');
            const therapists = therapistsData[line];
            
            grid.innerHTML = therapists.map(t => `
                <div class="therapist-card" onclick="selectTherapist('${t.id}')" style="--hover-color: ${t.color}">
                    <div class="avatar">${t.avatar}</div>
                    <h3>${t.name}</h3>
                    <div class="years">${t.years}</div>
                    <div class="specialty">${t.specialty}</div>
                    <div class="style">üìã ${t.style}</div>
                    <div class="quote">${t.quote}</div>
                </div>
            `).join('');
        }

        function selectTherapist(therapistId) {
            const therapists = therapistsData[currentLine];
            currentTherapist = therapists.find(t => t.id === therapistId);
            
            showScreen('screen-chat');
            updateTherapistUI();
            initSpeechRecognition();
            connectWebSocket();
        }

        function updateTherapistUI() {
            document.getElementById('avatar').textContent = currentTherapist.avatar;
            document.getElementById('therapist-name').textContent = currentTherapist.name;
            document.getElementById('therapist-desc').textContent = currentTherapist.specialty;
            document.getElementById('therapist-quote').textContent = currentTherapist.quote;
            document.getElementById('therapist-style').textContent = 'üìã ' + currentTherapist.style;
        }

        function connectWebSocket() {
            updateStatus('Conectando...', '');
            const approach = currentLine + '_' + currentTherapist.id;
            
            // Detectar se √© localhost ou produ√ß√£o
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            ws = new WebSocket(`${protocol}//${host}/ws/voice/${approach}`);
            
            ws.onopen = () => updateStatus('Conectado - Pronto para conversar', 'connected');
            ws.onmessage = (event) => handleResponse(JSON.parse(event.data));
            ws.onerror = () => updateStatus('Erro na conex√£o', 'error');
            ws.onclose = () => updateStatus('Desconectado', 'error');
        }

        async function handleResponse(data) {
            if (data.type === 'response') {
                addMessage(data.text, 'therapist');
                
                // Falar a resposta
                await speak(data.text, currentTherapist.gender);
                
                if (data.crisis_info) showCrisisAlert();
            }
        }

        function addMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.textContent = text;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            // Parar qualquer fala em andamento
            synthesis.cancel();
            
            addMessage(text, 'user');
            ws.send(JSON.stringify({ command: 'text_message', text: text }));
            input.value = '';
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function backToLines() {
            if (ws) ws.close();
            synthesis.cancel();
            currentLine = null;
            showScreen('screen-lines');
        }

        function backToTherapists() {
            if (ws) ws.close();
            synthesis.cancel();
            document.getElementById('messages').innerHTML = '';
            currentTherapist = null;
            showScreen('screen-therapists');
        }

        function showCrisisAlert() {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'crisis-alert';
            alertDiv.innerHTML = '<p>Se voc√™ est√° em crise, ligue agora:</p><a href="tel:188">üìû CVV: 188</a>';
            document.getElementById('messages').appendChild(alertDiv);
        }

        function updateStatus(text, className) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = 'status ' + className;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadVoices();
        });
    </script>
</body>
</html>
